%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Institut f"ur Rechnergestuetzte Automation
% Forschungsgruppe Industrial Software
% Arbeitsgruppe ESSE
% http://security.inso.tuwien.ac.at/
% lva.security@inso.tuwien.ac.at
% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[12pt,a4paper,titlepage,oneside]{scrartcl}
\usepackage{esseProtocol}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% FOR STUDENTS
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Group number or "0" for Lab0
\newcommand{\gruppe}{4}
% Date
\newcommand{\datum}{15.05.2013}
% valid values: "Lab0", "Lab1" (be sure to use Uppercase for first character)
\newcommand{\lab}{Lab1}

% name of course, for example: "IT Security in Large IT Infrastructures", "Security for Systems Engineering", "Introduction to Security"
\newcommand{\lvaname}{Security for Systems Engineering}
% number of course, for example: "183.633", "183.637", "183.594"
\newcommand{\lvanr}{183.637}
% year and term, for example: "SS 2012", "WS 2012", "SS 2013", etc.
\newcommand{\semester}{SS 2013}

% Student data in Lab0 or first student of group in Lab1
\newcommand{\studentAName}{Srdjan Markovic}
\newcommand{\studentAMatrnr}{1025857}
\newcommand{\studentAEmail}{e1025857@student.tuwien.ac.at}

% second student of group in Lab1, for Lab0 you may leave it unchanged
\newcommand{\studentBName}{Julian Großhauser}
\newcommand{\studentBMatrnr}{1026751}
\newcommand{\studentBEmail}{e1026751@student.tuwien.ac.at}

% second student of group in Lab1, for Lab0 you may leave it unchanged
\newcommand{\studentCName}{Bruno Bajtela}
\newcommand{\studentCMatrnr}{0925302}
\newcommand{\studentCEmail}{e0925302@student.tuwien.ac.at}

\newcommand{\studentDName}{Aleksandar Sibincic}
\newcommand{\studentDMatrnr}{0727895}
\newcommand{\studentDEmail}{e0727895@student.tuwien.ac.at}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% DO NOT CHANGE THE FOLLOWING PART
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\dokumenttyp}{Abgabedokument \lab}

\begin{document}

\maketitle
\setcounter{section}{0}
\setcounter{tocdepth}{2}
\tableofcontents

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% CONTENT OF DOCUMENT STARTS HERE
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Lab1a}

\subsection{Vorgehensweise}
Nachdem man sich in die Übungsumgebung einloggt, stehen einem keine Web Browsing tools (wie zB. browsers, lynx, links o.ä.) zu Verfügung. Deshalb muss man einen anderer Weg finden, die Homepage auf einen Rechner, der von aussen erreichbar ist, zu sehen. Eine Möglichkeit wäre hier einen SSH Tunnel(Port Forwarding) zu bauen.
\\ \url{http://wiki.ubuntuusers.de/SSH#SSH-Tunnel}
\\ \url{http://blog.ch-becker.de/2011/02/20/ssh-tunnel-mit-linux/}
\\
\\Wir haben folgenden Befehl ausgeführt um einen SSH Tunnel zu bauen:
\\ssh -L 2008:192.168.20.100:8000 XXXXXXX@sela.inso.tuwien.ac.at -p 12345
\\Nachdem der Tunnel aufgebaut ist, kann man sich über diesen Port die Homepage auf dem veralteten Tomcat Server ansehen. Eingabe der URL \url{http://localhost:2008} bringt uns zur gewünschte Homepage. 
(\hyperref[fig:image1]{siehe Abbildung~\ref*{fig:image1} auf Seite~\pageref*{fig:image1}}).
\begin{figure}[h!]
  \centering
  \fbox{
    \includegraphics[width=0.4\textwidth]{./imgs/image1.png}
  }
  \caption{Homepage auf 192.168.20.100:8000}
  \label{fig:image1}
\end{figure}
\\
Um herauszufinden um welche Version des Tomcat Server sich handelt, genügt es eine ungültigen Anfrage zum Webserver zu senden. Wenn man z.B. die Resource /wrong auffordert (unter http://localhost:2008/wrong), bekommt man eine Fehlermeldung und man erkennt leicht, dass es sich um einen Tomcat Server Version 6.0.16 handelt.
(\hyperref[fig:image2]{siehe Abbildung~\ref*{fig:image2} auf Seite~\pageref*{fig:image2}}).
\begin{figure}[h!]
  \centering
  \fbox{
    \includegraphics[width=0.4\textwidth]{./imgs/image2.png}
  }
  \caption{Tomcat Version}
  \label{fig:image2}
\end{figure}
\\
Um den privaten Schlüssel für Benutzer walter zu bekommen, haben wir folgenden Befehl ausgeführt (siehe Schwachstellen und Angriff): \\\url{http://127.0.0.1:2008/\%c0\%ae\%c0\%ae/\%c0\%ae\%c0\%ae/\%c0\%ae\%c0\%ae/\%c0\%ae\%c0\%ae/\%c0\%ae\%c0\%ae/home/walter/.ssh/id_rsa}
\\Mit diesem Schlüssel haben wir einen SSH-Zugang auf dem Server.

\subsection{Schwachstellen und Angriff}
Unter \url{http://tomcat.apache.org/security-6.html} gibt es eine Liste der Tomcat-6.X.X Schwachstellen. Eine Liste der bekannten Schwachstellen für Tomcat-6.0.16 ist unter \\ \url{http://www.cvedetails.com/vulnerability-list/vendor_id-45/product_id-887/version_id-56605/Apache-Tomcat-6.0.16.html} zu finden. Die einzige hier gelistete Schwachstelle, die es einem als Angreifer ermöglicht beliebige Dateien zu lesen, ist Remote UTF-8 Directory Traversal. Eine genaue Beschreibung und Spezifikation findet man unter \url{http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2008-2938}. \\ 
Dieses Problem tritt auf, wenn 'allowLinking' und 'URIencoding=UTF-8' im Tomcat erlaubt sind. Der Grund dafür ist, dass JVM UTF-8-kodierte URLs nicht korrekt dekodiert. Wenn das webroot Verzeichnis zB. die Tiefe 3 hat (z.B. /usr/local/wwwroot), kann man auf folgende Weise auf beliebige Daten zugreifen: \\ http://www.target.com/\%c0\%ae\%c0\%ae/\%c0\%ae\%c0\%ae/\%c0\%ae\%c0\%ae/foo/bar   \\Eine mögliche Lösung um solche Angriffe zu vermeiden wäre entweder 'allowLinking' zu deaktivieren oder 'URIencoding' nicht auf UTF-8 zu setzen. Noch besser wäre ein Upgrade auf eine neuere Version des Tomcat Server. In der Version 6.0.18 wurde dieses Problem behoben. 


\section{Lab1b}

\subsection{Lab1}
Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. 

\subsection{Sub-Ueberschrift 2}
Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. 

\subsection{Sub-Ueberschrift 3}
Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua.

\section{Lab1c} 
\subsection{Lab1c - app0}
Im App0 wurden folgende Vulnerabilities gefunden:
\begin{description}
  \item[Integer und Heap-Buffer-Overflow] \hfill \\
    Der Integer-Overflow tritt Aufgrund der Subtraktion von -1 von einem size\_t-Typ mit dem Wert 0. Da size\_t unsigned ist, f"uhrt das zu einem wrap-around, so dass der neue Wert 0xFFFFFFFFFFFFFFFF ist. \newline
    Dieser Bug f"uhrt in weiter folge zu einem Heap-Buffer-Overflow, da i weit "uber MAX wachsen kann.\newline
    Diese beiden Overflows befinden sich in der Funktion strip (Zeile 12). Sie lassen sich durch eine leere Eingabe ausl"osen (da strlen dann 0 zur"uckliefert).
    Diese Vulnerability kann f"ur ein DOS genutzt werden.
    
  \item[Format-String] \hfill \\
  In der Funktion outprint (Zeile 54) wird der vom User eingegebene String als Format-String an printf "ubergeben.
    Um diese Vulnerability ausnutzen zu k"onnen, sind folgende Schritte notwendig:
    \begin{itemize}
        \item Format-Offset des Buffers bestimmen (da eventuell andere libc-Versionen eine andere Anzahl von Variablen in den printf-Funktionen haben.
        \item Zur CPU-Archtektur passenden Format-Offset zum oberem addieren, um die Adresse einer Stack-Frame zu erhalten.
        \item Aus dem Frame-Pointer, durch die CPU-Archektur und Compiler bestimmt, den Offset f"ur RIP auf dem Stack bestimmen.
        \item Durch den Format-Offset und den Stack-Frame-Pointer l"asst sich die Adresse des input-Buffers bestimmen.
        \item Aus diesen Daten kann der String f"ur den Angriff generiert werden:\\
        \begin{lstlisting}
${ripAdresse}$(($inputBufferAdresse-2*$Adresslaenge))${shellCode}%${formatOffset}\$n
        \end{lstlisting}
    \end{itemize}
    Anm.: Dieser Angriff funkioniert auch auf Systemen mit ASLR. Der oberige String ist in einer bash-"ahnlichen Syntax
    
    Durch \%s, ließe sich diese Technik auch zum Lesen vom Speicher nutzen (wobei dies nat"urlich nur bis zum n"achsten \textbackslash0 geht).
    \item[Memory Leak]
    Da der in strip allozierte Speicher nie freigegeben wird, wird ab einem Zeitpunkt kein freier Speicher am Heap zur Verfügung stehen. Da malloc in diesem Fall meist NULL liefert, wird das Programm, beim Versuch diese Adresse zu dereferenzieren, terminiert (DOS-Angriff).
\end{description}

\subsection{Lab1c - app1}

\subsection{Lab1c - app2}

\section{Beispiele}

\subsection{Source Code formatieren}
Es folgen einige Beispiele wie Sourcecode in diesem Dokument formatiert und referenziert werden kann
(\hyperref[code:beispiel1]{siehe Listing~\ref*{code:beispiel1} auf Seite~\pageref*{code:beispiel1}} und \hyperref[code:beispiel2]{siehe Listing~\ref*{code:beispiel2} auf Seite~\pageref*{code:beispiel2}}).

Ebenso k"onnen kurzer Code oder kurze Befehle direkt in der Zeile in einem \lstinline{lstinline Block} mit typengleicher Schrift formatiert werden.

%\lstinputlisting[caption=Example C/C++ file,label=code:beispiel1,style=c]{example.c}

\begin{lstlisting}[caption=Example bash script,label=code:beispiel2,style=simple]
#!/bin/bash
echo "Bash version ${BASH_VERSION}..."
for i in {0..10..2}
  do
     echo "Welcome $i times"
 done

echo "some very very very very very very very very very very very very very very very very very very very very long string"

exit 0;
\end{lstlisting}

\subsection{Bilder}

Es folgen einige Beispiele wie Bilder in diesem Dokument eingefuegt werden koennen
(\hyperref[fig:logo1]{siehe Abbildung~\ref*{fig:logo1} auf Seite~\pageref*{fig:logo1}}).

\begin{figure}[h!]
  \centering
  \fbox{
    \includegraphics[width=0.4\textwidth]{./imgs/esse-logo-bw.png}
  }
  \caption{ESSE Logo}
  \label{fig:logo1}
\end{figure}


\end{document}


